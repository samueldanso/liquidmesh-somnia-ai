# ü§ñ LiquidMesh Agents

**Multi-agent orchestration system for autonomous concentrated liquidity management on Somnia.**

### Core System

-   ‚úÖ **EventBus** - Agent communication
-   ‚úÖ **Base Agent** class - Common agent interface
-   ‚úÖ **Memory System** - Supabase for thought persistence
-   ‚úÖ **Data Integrations** - DefiLlama metrics, Somnia RPC balances, positions

### Three Specialized Agents

1. **Watcher Agent** - Monitors liquidity pools, generates market intelligence reports
2. **Strategist Agent** - Analyzes reports, generates optimal rebalancing strategies
3. **Executor Agent** - Executes strategies

### DEX Integrations (Adapters)

-   ‚úÖ Somnia Exchange V2 (router-based) ‚Äî implemented in `src/adapters/somnia-exchangev2.ts`
    -   Uses Uniswap V2-style router for add/remove liquidity
    -   Testnet Router: configured in code; tokens: wSTT/USDC
-   ‚è≥ Somnex V3 (concentrated liquidity) ‚Äî stub in `src/adapters/somnex-v3.ts`
    -   Awaits factory/position manager addresses on Somnia Testnet
-   ‚è≥ QuickSwap V3 ‚Äî stub in `src/adapters/quickswap-v3.ts`
    -   Interface compatible with position manager; to be wired when endpoints are available

### File Structure

```
agents/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ adapters/            # DEX adapters (somnia-exchangev2, somnex-v3 stub, quickswap-v3 stub)
‚îÇ   ‚îú‚îÄ‚îÄ agents/              # watcher/, strategist/, executor/
‚îÇ   ‚îú‚îÄ‚îÄ comms/               # event-bus
‚îÇ   ‚îú‚îÄ‚îÄ memory/              # supabase client & persistence
‚îÇ   ‚îú‚îÄ‚îÄ routes/              # /thoughts, /positions, /agents/* HTTP endpoints
‚îÇ   ‚îú‚îÄ‚îÄ env.ts               # typed environment loader
‚îÇ   ‚îú‚îÄ‚îÄ setup.ts             # initialization & exports
‚îÇ   ‚îú‚îÄ‚îÄ app.ts               # Hono server setup
‚îÇ   ‚îî‚îÄ‚îÄ index.ts             # Entry point
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md

# Render config lives at repo root: ./render.yaml
```

### API Layer

-   **Hono** server with CORS
-   **GET /thoughts** - All agent thoughts
-   **GET /thoughts/:agent** - Specific agent thoughts
-   **GET /positions** - Liquidity positions
-   **GET /positions/pools** - Pool metrics

## ‚öôÔ∏è Configuration

### Environment Variables

````env
# Required
OPENAI_API_KEY=sk-...                   # OpenAI for agent reasoning
SUPABASE_URL=https://<project>.supabase.co
SUPABASE_KEY=your-anon-key
PRIVATE_KEY=0x...                        # Executor wallet (fallback)

# Optional / Network
SOMNIA_RPC_URL=https://dream-rpc.somnia.network
CHAIN_ID=50312
CHAIN_NAME=somnia-testnet

# Server
PORT=8000
AUTO_START=false                         # Start loop on boot
CHECK_INTERVAL_HOURS=2                   # Periodic cycle hours
MODEL_NAME=gpt-4o

# Strategy loop (automation endpoints)
STRATEGY_AUTOMATION_ENABLED=false
STRATEGY_INTERVAL_MINUTES=2
STRATEGY_COOLDOWN_MINUTES=10

## üöÄ Quick Start

### 1. Setup Supabase Database

Go to your **Supabase Dashboard** ‚Üí SQL Editor and run these commands:

```sql
-- Table for storing agent thoughts and tool calls
CREATE TABLE thoughts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  agent TEXT NULL,
  text TEXT NULL,
  tool_calls JSON NULL,
  tool_results JSON NULL
);

-- Table for storing reports with embeddings for semantic search
CREATE TABLE documents (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  content TEXT,
  embedding VECTOR(1536)
);

-- Enable pgvector extension (if not already enabled)
CREATE EXTENSION IF NOT EXISTS vector;

-- Function for semantic search using embeddings
CREATE OR REPLACE FUNCTION match_documents (
  query_embedding VECTOR(1536),
  match_threshold FLOAT,
  match_count INT
)
RETURNS TABLE (
  id BIGINT,
  content TEXT,
  similarity FLOAT
)
LANGUAGE SQL STABLE
AS $$
  SELECT
    documents.id,
    documents.content,
    1 - (documents.embedding <=> query_embedding) AS similarity
  FROM documents
  WHERE 1 - (documents.embedding <=> query_embedding) > match_threshold
  ORDER BY similarity DESC
  LIMIT match_count;
$$;
````

### 2. Install Dependencies & Configure

```bash
# Install dependencies
bun install

# Set up environment (copy .env.example to .env and fill in)
cp .env.example .env

# Required in .env:
- OPENAI_API_KEY=sk-...
- SUPABASE_URL=https://your-project.supabase.co
- SUPABASE_KEY=your-anon-key
- PRIVATE_KEY=0x...
```

### 3. Run Agents

```bash
bun run dev
```

**Note:** By default, agents won't auto-start. Use the API to control them.

## ‚òÅÔ∏è Deploy (Render)

-   Runtime: Bun
-   Root Directory: `agents`
-   Build: `bun install`
-   Start: `bun start`
-   Configure the environment variables above in the Render dashboard (render.yaml included for convenience).

## üéÆ Agent Control System

### Control Endpoints

```bash
# Start autonomous monitoring
POST /agents/start

# Stop monitoring
POST /agents/stop

# Check status
GET /agents/status

# Response example:
{
  "isRunning": true,
  "wallet": "0x...",
  "cycleCount": 5,
  "checkIntervalHours": 2,
  "nextCheckIn": "2 hours",
  "status": "online"
}
```

### Usage Flow

1. **Deploy to Production**: Agents stay idle (no OpenAI costs)
2. **Start Monitoring**: `POST /agents/start` ‚Üí Begins autonomous loop
3. **Dashboard Updates**: Frontend polls for real-time status
4. **Periodic Checks**: Agents check every 2 hours (configurable)
5. **Stop Anytime**: `POST /agents/stop` ‚Üí Agents go idle

## üìä Agent Flow & Autonomous Loop

```
Watcher ‚Üí Strategist ‚Üí Executor ‚Üí Strategist ‚Üí Watcher
   ‚Üì          ‚Üì           ‚Üì              ‚Üì
  Data     AI          TX          Store Report

When stable: noFurtherActionsTool ‚Üí Wait (configurable) ‚Üí Restart
```

### Testing

```bash
bun run typecheck

# Test API
curl http://localhost:8000
curl http://localhost:8000/thoughts
curl http://localhost:8000/positions
curl http://localhost:8000/positions/pools

# Agents lifecycle
curl -X GET http://localhost:8000/agents/status
curl -X POST http://localhost:8000/agents/start
curl -X POST http://localhost:8000/agents/stop

# Start for a specific wallet
curl -X POST http://localhost:8000/agents/start/0xYourWalletAddress

# Latest adapter tx hash (for UI activity)
curl -X GET http://localhost:8000/agents/tx/latest

# Automation controls
curl -X GET http://localhost:8000/agents/automation/status
curl -X POST http://localhost:8000/agents/automation/start \
  -H "content-type: application/json" \
  -d '{"intervalMinutes":2, "cooldownMinutes":10}'
curl -X POST http://localhost:8000/agents/automation/stop
```

**Built for Somnia AI Hackathon 2025 üöÄ**
