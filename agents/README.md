# üß© LiquidMesh AgentMesh Orchestrator

A multi-agent DeFi system that autonomously monitors Somnia liquidity conditions and executes concentrated liquidity management strategies for maximum capital efficiency and superior risk-adjusted yield.

This system coordinates specialized AI agents to continuously optimize liquidity positions across Somnia DEXes.

## ‚ö†Ô∏è Attention

**Autonomous agents** must be - by definition - autonomous. This system executes real transactions with tesnet funds being moved from its wallet on Somnia.

Make sure that you understand how it works, why it works in this way and you are ready to take any of the risks that this entails.

Please refer to the [Disclaimer](#disclaimer) section for more information on your responsibilities when running this code.

## üìö Overview

This system consists of three main AI agents working together:

1. **Watcher Agent**: Monitors Somnia DEX pool metrics, market conditions, and liquidity position status to generate market intelligence reports;
2. **Strategist Agent**: Analyzes watcher reports and determines optimal liquidity management strategies;
3. **Executor Agent**: Safely executes the approved liquidity management tasks on Somnia DEXes.

### üîé Watcher Agent

The goal of the **Watcher Agent** is to generate reports about the current state of Somnia DEXes, the status of liquidity positions, and market conditions. This report will be sent to the **Strategist Agent** that will either approve it and generate strategies or reject it and ask for a new report.

#### Watcher Agent Behavior

The Watcher Agent behaves following the system prompt defined in `src/system-prompts/watcher-system-prompt.ts`.

Key responsibilities:

-   Monitor Somnia DEX pool metrics (price, volume, volatility, range status)
-   Track current liquidity position performance
-   Analyze market conditions and opportunities
-   Generate comprehensive market intelligence reports
-   Send structured data to Strategist Agent

### üìù Strategist Agent

The goal of the **Strategist Agent** is to analyze the report generated by the **Watcher Agent** and generate optimal liquidity management strategies based on the report. It can also reject the report and ask for a new one.

At the end of the whole flow it will generate a final report that will be used to store the results of the executed strategies.

#### Strategist Agent - Main Behavior

The Strategist Agent behaves following the system prompt defined in `src/system-prompts/strategist-system-prompt.ts`.

Key responsibilities:

-   Analyze Watcher reports and market conditions
-   Determine optimal liquidity range adjustments
-   Generate rebalancing strategies
-   Create fee optimization plans
-   Send strategy decisions to Executor Agent

### üîë Executor Agent

The goal of the **Executor Agent** is to execute the strategies generated by the **Strategist Agent**. It will generate the transactions for Somnia DEXes and then execute them.

#### Executor Agent Behavior

The Executor Agent behaves following the system prompt defined in `src/system-prompts/executor-system-prompt.ts`.

Key responsibilities:

-   Process strategy decisions from Strategist
-   Prepare transactions for Somnia DEXes
-   Execute liquidity position changes
-   Verify transaction success
-   Return execution results and status

## üõ†Ô∏è Agent Tools

Each agent has its own tools, defined in their own `toolkit.ts` file.

### Watcher Agent Tools

The current available tools for the watcher agent are:

-   `getPoolMetrics`: Fetch current pool data from Somnia DEXes
-   `getMarketData`: Retrieve market conditions and opportunities
-   `getWalletBalances`: Check current liquidity positions
-   `getPastReports`: Retrieve historical agent decisions
-   `noFurtherActions`: Indicate when monitoring is sufficient

### Strategist Agent Tools

The current available tools for the strategist agent are:

-   `sendMessageToWatcher`: Request additional market data
-   `sendMessageToExecutor`: Send strategy decisions for execution
-   `analyzeMarketConditions`: Process market intelligence
-   `generateStrategy`: Create optimal liquidity strategies

### Executor Agent Tools

The current available tools for the executor agent are:

-   `getTransactionData`: Prepare transaction data for Somnia DEXes
-   `simulateTransactions`: Test transactions before execution
-   `executeTransaction`: Execute liquidity position changes
-   `verifyExecution`: Confirm transaction success

## üí¨ Communication between agents

The communication between agents is done through a simple NodeJS `EventEmitter` that is used to send messages between the agents.

The agents then react to these messages and act accordingly.

The `EventBus` class is defined in `src/comms/event-bus.ts`. Each agent has its own `handleEvent` method that is used to react to the messages.

The communication in this particular use case happens in this way:

-   The watcher agent generates a report and sends it to the strategist agent;
-   The strategist agent analyzes the report and generates strategies;
-   The strategist agent sends the strategies to the executor agent;
-   The executor agent executes the strategies and generates a report feedback;
-   The executor agent sends the report feedback to the strategist agent;
-   The strategist agent generates a final report with both the watcher and executor reports and stores it for later retrieval.

## üì• Memory

The memory is stored in a **Supabase** database and is used to store the past reports and retrieve them when needed.

The memory is stored in the `documents` table of the `liquidmesh-agents` database.

The `documents` table has two columns:

-   `content`: the content of the document, which is the report;
-   `embedding`: the embedding of the document, which is used for semantic search.

The `documents` table has a `match_documents` function that is used to retrieve the past reports from the database.

Please make sure to set the `query_embedding` column vector size to **1536** for OpenAI embeddings' size.

## ‚öôÔ∏è HTTP APIs

LiquidMesh exposes **by default** some APIs that can be used to build your own UI on top of it.

These are the routes exposed by the system:

-   `/thoughts`: this route is used to retrieve the thoughts of the agents;
-   `/thoughts/:agent`: this route is used to retrieve the thoughts of a specific agent (eg. `/thoughts/watcher`);
-   `/positions`: this route is used to retrieve liquidity position information. It returns the current positions, performance metrics, and historical data.

## üßëüèª‚Äçüíª Development Guide

**LiquidMesh** is a complex system, and requires a little bit of setup to be able to run it. Let's see all the different steps.

### 1. Setup the database

You need to create an account on [Supabase](https://supabase.com/) and create a new project. Inside the project you need to create the documents table (see [Memory](#-memory) section for more information) and the following tables:

-   `positions`: this table is used to store the liquidity positions;

```SQL
create table
  public.positions (
    id uuid not null default gen_random_uuid(),
    created_at timestamp with time zone not null default now(),
    token_pair text not null,
    current_range json not null,
    liquidity text not null,
    fees_earned text not null,
    apy text not null,
    constraint positions_pkey primary key (id)
  ) tablespace pg_default;
```

-   `thoughts`: this table is used to store all the different agents' thoughts and messages.

```SQL
create table
  public.thoughts (
    id bigint generated by default as identity not null,
    created_at timestamp with time zone not null default now(),
    agent text null,
    text text null,
    tool_calls json null,
    tool_results json null,
    constraint thoughts_pkey primary key (id)
  ) tablespace pg_default;
```

### 2. Setup the environment variables

You need to create a `.env` file in the root of the project with the following variables:

```
OPENAI_API_KEY=""
SUPABASE_URL=""
SUPABASE_KEY=""
SOMNIA_RPC_URL="https://rpc.somnia.network"
SOMNIA_CHAIN_ID="1"
PRIVATE_KEY=""
WALLET_ADDRESS=""
PORT="8000"
AGENT_INTERVAL="300000"
MAX_GAS_PRICE="1000000000"
```

-   The `OPENAI_API_KEY` is the API key for OpenAI. You can get it from [OpenAI](https://openai.com/);
-   The `SUPABASE_URL` and `SUPABASE_KEY` are for the Supabase database;
-   The `SOMNIA_RPC_URL` is the RPC endpoint for Somnia network;
-   The `PRIVATE_KEY` is the private key of the wallet that will be used for transactions;
-   The `WALLET_ADDRESS` is the address of the wallet that will be used for transactions.

### 3. Running the system

Run the system using `bun`:

```bash
bun src/index.ts
```

You will see the logs of the system in the console.

### Changing the agents' behaviors and tools

You can change the agents' behaviors by editing the `src/system-prompts` folder. Each agent has its own file.

You can update the system prompts so that the agents behave differently: an example could be changing the system to be more aggressive or more conservative in liquidity management.

Changing the behavior may include updating the existing tools or create new ones: you can do so in the `toolkit.ts` file of each agent, most likely you need to intervene only on the watcher agent toolkit to retrieve different information, like different DEX protocols, etc.

## ü§ùüèª Contributing

Contributions are welcome! Please feel free to submit a Pull Request. We're looking for a lot of improvements, optimizations, new features and new use cases. Feel also free to fork this project and create your own version of it.

## üõ°Ô∏è License

This project is licensed under the terms of the MIT license. See LICENSE for more details.
